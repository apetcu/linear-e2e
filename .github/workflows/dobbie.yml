name: Dobbie

on:
  workflow_dispatch:
    inputs:
      command:
        required: true
        type: string
      triggered_by:
        required: false
        type: string
        default: "unknown"
  repository_dispatch:
    types: [dobbie]

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
      id-token: write

    steps:
      # 1️⃣ Checkout code
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 2️⃣ Install Python dependencies
      - name: Install dependencies
        run: pip install requests

      # 3️⃣ Fetch Jira ticket
      - name: Fetch Jira ticket
        id: jira
        env:
          COMMAND: ${{ github.event.inputs.command || github.event.client_payload.command }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: python .github/workflows/inspect_ticket.py fetch

      # 4️⃣ Transition ticket to In Progress
      - name: Transition to In Progress
        if: steps.jira.outputs.found == 'true'
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          python .github/workflows/inspect_ticket.py transition \
            "${{ steps.jira.outputs.ticket }}" \
            "In Progress"

      # 5️⃣ Fix issue with Claude
      - name: Fix issue with Claude
        if: steps.jira.outputs.found == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: '--allowed-tools "Bash,Edit,Write" --dangerously-skip-permissions'
          prompt: |
            You are fixing a Jira ticket in this repository.

            IMPORTANT: Do NOT modify any files in .github/workflows/. Only commit files related to the fix.
            When committing, only stage the specific files you changed — do not use "git add ." or "git add -A".

            Ticket: ${{ steps.jira.outputs.ticket }}
            Summary: ${{ steps.jira.outputs.summary }}
            Status: ${{ steps.jira.outputs.status }}
            Description:
            ${{ steps.jira.outputs.description }}

            ${{ steps.jira.outputs.has_attachments == 'true' && 'Attachments have been saved to ./attachments/ — read them for additional context.' || 'No attachments.' }}

            Analyze the codebase and fix the issue described in the ticket.
            Commit the changes on a new branch.
            Create a pull request targeting the main branch.
            The pull request should be created with the title "SNDY-${{ steps.jira.outputs.ticket }}: ${{ steps.jira.outputs.summary }}"
            The pull request should be created with the body "SNDY-${{ steps.jira.outputs.ticket }}: ${{ steps.jira.outputs.summary }}"

      # 6️⃣ Find the PR URL
      - name: Find PR URL
        if: steps.jira.outputs.found == 'true'
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_URL=$(gh pr list --state open --limit 1 --search "${{ steps.jira.outputs.ticket }}" --json url --jq '.[0].url // empty')
          echo "url=$PR_URL" >> "$GITHUB_OUTPUT"

      # 7️⃣ Comment ticket fixed with PR link
      - name: Comment ticket fixed
        if: steps.jira.outputs.found == 'true'
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          python .github/workflows/inspect_ticket.py comment \
            "${{ steps.jira.outputs.ticket }}" \
            "Ticket fixed (triggered by ${{ github.event.inputs.triggered_by || github.event.client_payload.triggered_by || 'repository_dispatch' }} via Dobbie)" \
            "${{ steps.pr.outputs.url }}"

      # 8️⃣ Transition ticket to In Review
      - name: Transition to In Review
        if: steps.jira.outputs.found == 'true'
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          python .github/workflows/inspect_ticket.py transition \
            "${{ steps.jira.outputs.ticket }}" \
            "In Review"