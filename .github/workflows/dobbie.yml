name: Dobbie

on:
  workflow_dispatch:
    inputs:
      command:
        required: true
        type: string
      triggered_by:
        required: false
        type: string
        default: "unknown"
  repository_dispatch:
    types: [dobbie]

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
      id-token: write

    steps:
      # 1️⃣ Checkout code
      - uses: actions/checkout@v4

      # 2️⃣ Install Python dependencies
      - name: Install dependencies
        run: pip install requests

      # 3️⃣ Fetch Jira ticket
      - name: Fetch Jira ticket
        id: jira
        env:
          COMMAND: ${{ github.event.inputs.command || github.event.client_payload.command }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: python .github/workflows/inspect_ticket.py fetch

      # 4️⃣ Fix issue with Claude
      - name: Fix issue with Claude
        if: steps.jira.outputs.found == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You are fixing a Jira ticket in this repository.

            Ticket: ${{ steps.jira.outputs.ticket }}
            Summary: ${{ steps.jira.outputs.summary }}
            Status: ${{ steps.jira.outputs.status }}
            Description:
            ${{ steps.jira.outputs.description }}

            ${{ steps.jira.outputs.has_attachments == 'true' && 'Attachments have been saved to ./attachments/ — read them for additional context.' || 'No attachments.' }}

            Analyze the codebase and fix the issue described in the ticket.
            Commit the changes to the repository and create a pull request.
            The pull request should be created on the main branch.
            The pull request should be created with the title "Fix: ${{ steps.jira.outputs.summary }}"
            The pull request should be created with the body "Fix: ${{ steps.jira.outputs.summary }}"
            The pull request should be created with the body "Fix: ${{ steps.jira.outputs.summary }}"

      # 5️⃣ Comment ticket fixed
      - name: Comment ticket fixed
        if: steps.jira.outputs.found == 'true'
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          python .github/workflows/inspect_ticket.py comment \
            "${{ steps.jira.outputs.ticket }}" \
            "Ticket fixed (triggered by ${{ github.event.inputs.triggered_by || github.event.client_payload.triggered_by || 'repository_dispatch' }} via Dobbie)"